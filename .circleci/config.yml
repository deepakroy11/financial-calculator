version: 2.1

jobs:
  build:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Run build
          command: npm run build
      - persist_to_workspace:
          root: .
          paths:
            - .
  deploy:
    machine: true
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Sync Code to VPS
          command: |
            ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "mkdir -p ${SSH_PATH}"
            rsync -avz --delete \
              --exclude ".git/" \
              --exclude ".circleci/" \
              -e "ssh -p ${SSH_PORT}" \
              ./ "${SSH_USER}@${SSH_HOST}:${SSH_PATH}/financial-calculator"
      - run:
          name: Deploy to VPS
          command: |
            ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "
              cd ${SSH_PATH} && \
              NODE_ENV='production' \
              docker compose up -d --build financial-calculator
            "
      - run:
          name: Prune Docker Build Cache
          command: |
            ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" "
             docker builder prune --all --force
            "

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: main
